<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ì€í–‰ íšŒí™” ì¹´ë“œ (ëª¨ë°”ì¼ TTS)</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121926; --card2:#0f1623;
      --text:#e8eef7; --muted:#a9b4c2; --accent:#7ee0ff;
      --good:#59d98e; --bad:#ff6b6b; --line:#263247;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px; --pad: 14px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR","Apple SD Gothic Neo", sans-serif;
      min-height:100vh; display:flex; justify-content:center;
      background: radial-gradient(1200px 800px at 50% -20%, rgba(126,224,255,.12), transparent 55%),
                  radial-gradient(900px 700px at 90% 10%, rgba(89,217,142,.10), transparent 55%),
                  var(--bg);
      -webkit-tap-highlight-color: transparent;
    }
    .app{
      width:100%;
      max-width: 520px;
      padding:
        calc(10px + env(safe-area-inset-top))
        var(--pad)
        calc(16px + env(safe-area-inset-bottom));
    }

    /* ìƒë‹¨ ê³ ì • í—¤ë” */
    .stickyTop{
      position: sticky;
      top: calc(0px + env(safe-area-inset-top));
      z-index: 20;
      padding-top: 6px;
      background: linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.65), transparent);
      backdrop-filter: blur(10px);
    }

    header{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      margin: 0 0 10px;
    }
    h1{margin:0; font-size:17px; letter-spacing:-.2px;}
    .sub{color:var(--muted); font-size:12.2px; line-height:1.35; margin-top:6px;}
    .pill{
      border:1px solid var(--line);
      background: rgba(18,25,38,.55);
      border-radius:999px; padding:8px 10px;
      font-size:12px; color:var(--muted);
      display:flex; gap:8px; align-items:center; white-space:nowrap;
    }
    .pill b{color:var(--text); font-weight:700;}

    .progress{
      height:8px; background: rgba(38,50,71,.55);
      border-radius:999px; overflow:hidden;
      border:1px solid rgba(38,50,71,.6);
      margin: 8px 0 10px;
    }
    .bar{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(126,224,255,.95), rgba(89,217,142,.95));
      transition: width .25s ease;
    }

    /* ë± ì„ íƒ: ëª¨ë°”ì¼ í° ì„¸ê·¸ */
    .seg{
      display:flex; gap:8px; padding:8px;
      border-radius:16px;
      border:1px solid rgba(38,50,71,.85);
      background: rgba(18,25,38,.45);
      margin-bottom: 10px;
    }
    .seg button{
      flex:1; padding:12px 10px;
      border-radius:14px;
      font-size:13px; font-weight:800;
      border:1px solid rgba(38,50,71,.85);
      background: rgba(11,15,20,.25);
      color:var(--muted);
      box-shadow:none;
      touch-action: manipulation;
    }
    .seg button.active{
      color:var(--text);
      border-color: rgba(126,224,255,.55);
      background: rgba(126,224,255,.10);
    }

    .cardWrap{ perspective: 1200px; position:relative; margin-top: 8px; }
    .card{
      background: linear-gradient(180deg, rgba(18,25,38,.95), rgba(15,22,35,.95));
      border: 1px solid rgba(38,50,71,.85);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-height: 54vh; /* ëª¨ë°”ì¼ì—ì„œ í™”ë©´ ê½‰ */
      padding: 16px 16px 14px;
      transform-style: preserve-3d;
      transition: transform .45s cubic-bezier(.2,.75,.2,1);
      position:relative; overflow:hidden;
      user-select:none; -webkit-user-select:none;
      touch-action: pan-y;
    }
    .card::before{
      content:""; position:absolute; inset:-2px; pointer-events:none;
      background: radial-gradient(700px 400px at 20% 0%, rgba(126,224,255,.10), transparent 60%),
                  radial-gradient(700px 420px at 90% 20%, rgba(89,217,142,.08), transparent 60%);
    }
    .card.flipped{ transform: rotateY(180deg); }

    .face{
      position:absolute; inset:0;
      padding: 16px 16px 14px;
      backface-visibility:hidden;
      display:flex; flex-direction:column; gap:12px;
    }
    .back{ transform: rotateY(180deg); }

    .meta{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .tag{
      display:inline-flex; gap:8px; align-items:center;
      padding: 6px 10px; border-radius:999px;
      border:1px solid rgba(38,50,71,.85);
      background: rgba(11,15,20,.35);
      color:var(--muted); font-size:12px;
    }
    .hint{ font-size:12px; color:var(--muted); opacity:.95; }

    .textBlock{
      border-radius: 14px;
      border:1px solid rgba(38,50,71,.7);
      background: rgba(11,15,20,.25);
      padding: 14px 12px 12px;
      display:flex; flex-direction:column; gap:12px;
    }
    .zh{ font-size:22px; line-height:1.38; letter-spacing:-.2px; }
    .py{ font-size:15px; color: var(--accent); line-height:1.35; word-break:break-word; }
    .ko{ font-size:15px; color: var(--text); opacity:.92; line-height:1.5; }

    .mini{ display:flex; flex-wrap:wrap; gap:8px; margin-top:auto; }
    .chip{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(38,50,71,.8);
      background: rgba(11,15,20,.18);
      padding: 8px 11px; border-radius: 999px;
    }

    /* í•˜ë‹¨ ê³ ì • ì»¨íŠ¸ë¡¤(ì—„ì§€ì¡´) */
    .bottomDock{
      position: sticky;
      bottom: calc(0px + env(safe-area-inset-bottom));
      z-index: 30;
      margin-top: 12px;
      padding-bottom: 6px;
      background: linear-gradient(0deg, rgba(11,15,20,.95), rgba(11,15,20,.65), transparent);
      backdrop-filter: blur(10px);
    }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top: 10px; }
    .grid3{ display:grid; grid-template-columns: 1.2fr 1fr 1fr; gap:10px; margin-top: 10px; }

    button{
      border:1px solid rgba(38,50,71,.9);
      background: rgba(18,25,38,.6);
      color: var(--text);
      padding: 14px 12px;
      border-radius: 16px;
      font-size: 15px;
      font-weight: 900;
      letter-spacing:-.1px;
      box-shadow: 0 10px 28px rgba(0,0,0,.28);
      cursor:pointer;
      touch-action: manipulation;
    }
    button:active{ transform: translateY(1px); }
    .ttsBtn{ border-color: rgba(126,224,255,.55); background: rgba(126,224,255,.10); }
    .stopBtn{ border-color: rgba(255,107,107,.55); background: rgba(255,107,107,.10); }
    .good{ border-color: rgba(89,217,142,.65); }
    .bad{ border-color: rgba(255,107,107,.65); }
    .ghost{ opacity:.9; }

    .toggleRow{ display:flex; gap:10px; margin-top: 10px; }
    .toggle{
      flex:1;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border:1px solid rgba(38,50,71,.85);
      background: rgba(18,25,38,.5);
      border-radius: 16px;
      padding: 12px 12px;
      color: var(--muted);
      font-size: 13px;
    }
    .toggle input{ transform: scale(1.15); }

    .toast{
      position:fixed; left:50%;
      bottom: calc(16px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(18,25,38,.92);
      border:1px solid rgba(38,50,71,.9);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12.5px;
      color: var(--text);
      box-shadow: var(--shadow);
      opacity:0; pointer-events:none;
      transition: opacity .22s ease, transform .22s ease;
      z-index: 999;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-6px); }
  </style>
</head>

<body>
  <div class="app">
    <div class="stickyTop">
      <header>
        <div>
          <h1>ğŸ¦ ì€í–‰ íšŒí™” ì¹´ë“œ (ëª¨ë°”ì¼ TTS)</h1>
          <div class="sub">íƒ­=ë’¤ì§‘ê¸° Â· ì¢Œ/ìš° ìŠ¤ì™€ì´í”„=ì´ì „/ë‹¤ìŒ Â· ğŸ”Š=ì¤‘êµ­ì–´ ì½ê¸°</div>
        </div>
        <div class="pill"><span>ì§„í–‰</span><b id="pos">1</b><span>/</span><span id="total">0</span></div>
      </header>
      <div class="progress"><div class="bar" id="bar"></div></div>

      <div class="seg">
        <button id="deckAll" class="active">ì „ì²´</button>
        <button id="deckDialog">ëŒ€í™”ë§Œ</button>
        <button id="deckNarr">ë‚˜ë ˆì´ì…˜ë§Œ</button>
      </div>
    </div>

    <div class="cardWrap">
      <div class="card" id="card" role="button" aria-label="í•™ìŠµ ì¹´ë“œ">
        <div class="face front">
          <div class="meta">
            <div class="tag" id="frontTag">ì•ë©´ Â· ì¤‘êµ­ì–´</div>
            <div class="hint">íƒ­: ë³‘ìŒ/ëœ»</div>
          </div>
          <div class="textBlock">
            <div class="zh" id="frontZh">â€”</div>
          </div>
          <div class="mini" id="frontChips"></div>
        </div>

        <div class="face back">
          <div class="meta">
            <div class="tag" id="backTag">ë’·ë©´ Â· ë³‘ìŒ/ëœ»</div>
            <div class="hint">íƒ­: ì¤‘êµ­ì–´</div>
          </div>
          <div class="textBlock">
            <div class="zh" id="backZh">â€”</div>
            <div class="py" id="backPy">â€”</div>
            <div class="ko" id="backKo">â€”</div>
          </div>
          <div class="mini" id="backChips"></div>
        </div>
      </div>
    </div>

    <div class="bottomDock">
      <div class="grid2">
        <button class="ttsBtn" id="ttsZhBtn">ğŸ”Š ì¤‘êµ­ì–´ ì½ê¸°</button>
        <button class="stopBtn" id="ttsStopBtn">â¹ï¸ ì¤‘ì§€</button>
      </div>

      <div class="grid2">
        <button id="flipBtn">ë’¤ì§‘ê¸°</button>
        <button id="nextBtn">ë‹¤ìŒ</button>
      </div>

      <div class="grid3">
        <button class="bad" id="againBtn">ëª¨ë¦„</button>
        <button class="good" id="goodBtn">ì•</button>
        <button class="ghost" id="shuffleBtn">ì…”í”Œ</button>
      </div>

      <div class="toggleRow">
        <label class="toggle">
          <span>ìë™ì¬ìƒ(3ì´ˆ)</span>
          <input type="checkbox" id="autoPlay" />
        </label>
        <label class="toggle">
          <span>ëª¨ë¦„ ìš°ì„ </span>
          <input type="checkbox" id="unknownFirst" checked />
        </label>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ì €ì¥ë¨</div>

<script>
  const CARDS_ALL = [
    { type:"narr", zh:"ä»Šå¤©ä¸Šåˆï¼Œå°ä¸½å»é“¶è¡Œå–é’±ã€‚", py:"JÄ«ntiÄn shÃ ngwÇ”, XiÇolÃ¬ qÃ¹ yÃ­nhÃ¡ng qÇ” qiÃ¡n.", ko:"ì˜¤ëŠ˜ ì˜¤ì „, ìƒ¤ì˜¤ë¦¬ëŠ” ì€í–‰ì— ëˆì„ ì°¾ìœ¼ëŸ¬ ê°”ë‹¤.", tags:["ë‚˜ë ˆì´ì…˜","ìƒí™©"] },
    { type:"narr", zh:"é“¶è¡Œé‡Œäººä¸å¤šï¼Œå¾ˆå®‰é™ã€‚", py:"YÃ­nhÃ¡ng lÇ rÃ©n bÃº duÅ, hÄ›n ÄnjÃ¬ng.", ko:"ì€í–‰ ì•ˆì—ëŠ” ì‚¬ëŒì´ ë§ì§€ ì•Šì•„ ì¡°ìš©í–ˆë‹¤.", tags:["ë‚˜ë ˆì´ì…˜"] },
    { type:"narr", zh:"å¥¹æ‹¿ç€é“¶è¡Œå¡ï¼Œæ’é˜Ÿç­‰å€™ã€‚", py:"TÄ nÃ¡zhe yÃ­nhÃ¡ngkÇ, pÃ¡iduÃ¬ dÄ›nghÃ²u.", ko:"ê·¸ë…€ëŠ” ì€í–‰ì¹´ë“œë¥¼ ë“¤ê³  ì¤„ì„ ì„œì„œ ê¸°ë‹¤ë ¸ë‹¤.", tags:["ë‚˜ë ˆì´ì…˜","ë™ì‘"] },
    { type:"narr", zh:"è½®åˆ°å°ä¸½äº†ï¼Œå¥¹èµ°åˆ°çª—å£å‰ã€‚", py:"LÃºndÃ o XiÇolÃ¬ le, tÄ zÇ’u dÃ o chuÄngkÇ’u qiÃ¡n.", ko:"ìƒ¤ì˜¤ë¦¬ ì°¨ë¡€ê°€ ë˜ì ì°½êµ¬ ì•ìœ¼ë¡œ ê°”ë‹¤.", tags:["ë‚˜ë ˆì´ì…˜"] },

    { type:"dialog", zh:"ä½ å¥½ï¼Œè¯·é—®ä½ è¦åŠä»€ä¹ˆï¼Ÿ", py:"NÇhÇo, qÇngwÃ¨n nÇ yÃ o bÃ n shÃ©nme?", ko:"ì•ˆë…•í•˜ì„¸ìš”, ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?", tags:["ëŒ€í™”","ì§ì›"] },
    { type:"dialog", zh:"ä½ å¥½ï¼Œæˆ‘æƒ³å–é’±ã€‚", py:"NÇhÇo, wÇ’ xiÇng qÇ” qiÃ¡n.", ko:"ì•ˆë…•í•˜ì„¸ìš”, ëˆì„ ì°¾ê³  ì‹¶ì–´ìš”.", tags:["ëŒ€í™”","ì†ë‹˜"] },
    { type:"dialog", zh:"å¥½çš„ï¼Œè¯·ç»™æˆ‘ä½ çš„é“¶è¡Œå¡ã€‚", py:"HÇo de, qÇng gÄ›i wÇ’ nÇ de yÃ­nhÃ¡ngkÇ.", ko:"ë„¤, ì€í–‰ì¹´ë“œë¥¼ ì£¼ì„¸ìš”.", tags:["ëŒ€í™”","ì§ì›"] },
    { type:"dialog", zh:"å¥½çš„ï¼Œåœ¨è¿™é‡Œã€‚", py:"HÇo de, zÃ i zhÃ¨lÇ.", ko:"ë„¤, ì—¬ê¸°ìš”.", tags:["ëŒ€í™”","ì†ë‹˜"] },
    { type:"dialog", zh:"ä½ è¦å–å¤šå°‘é’±ï¼Ÿ", py:"NÇ yÃ o qÇ” duÅshao qiÃ¡n?", ko:"ì–¼ë§ˆë¥¼ ì°¾ìœ¼ì‹¤ ê±´ê°€ìš”?", tags:["ëŒ€í™”","ì§ì›","ê¸ˆì•¡"] },
    { type:"dialog", zh:"å–äº”åƒå—ã€‚", py:"QÇ” wÇ”qiÄn kuÃ i.", ko:"5ì²œ ìœ„ì•ˆì„ ì°¾ì„ê²Œìš”.", tags:["ëŒ€í™”","ì†ë‹˜","ê¸ˆì•¡"] },
    { type:"dialog", zh:"è¯·é—®è¦ç°é‡‘è¿˜æ˜¯è½¬è´¦ï¼Ÿ", py:"QÇngwÃ¨n yÃ o xiÃ njÄ«n hÃ¡ishi zhuÇnzhÃ ng?", ko:"í˜„ê¸ˆìœ¼ë¡œ ë“œë¦´ê¹Œìš”, ì´ì²´ë¡œ í•´ë“œë¦´ê¹Œìš”?", tags:["ëŒ€í™”","ì§ì›","ì„ íƒ"] },
    { type:"dialog", zh:"è¦ç°é‡‘ã€‚", py:"YÃ o xiÃ njÄ«n.", ko:"í˜„ê¸ˆìœ¼ë¡œìš”.", tags:["ëŒ€í™”","ì†ë‹˜"] },
    { type:"dialog", zh:"å¥½çš„ï¼Œè¯·è¾“å…¥å¯†ç ã€‚", py:"HÇo de, qÇng shÅ«rÃ¹ mÃ¬mÇ.", ko:"ë„¤, ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", tags:["ëŒ€í™”","ì§ì›"] },

    { type:"narr", zh:"å°ä¸½ä½å¤´è¾“å…¥å¯†ç ã€‚", py:"XiÇolÃ¬ dÄ«tÃ³u shÅ«rÃ¹ mÃ¬mÇ.", ko:"ìƒ¤ì˜¤ë¦¬ëŠ” ê³ ê°œë¥¼ ìˆ™ì´ê³  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í–ˆë‹¤.", tags:["ë‚˜ë ˆì´ì…˜"] },

    { type:"dialog", zh:"è¯·ç¨ç­‰ä¸€ä¸‹ã€‚", py:"QÇng shÄodÄ›ng yÃ­xiÃ .", ko:"ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.", tags:["ëŒ€í™”","ì§ì›"] },
    { type:"dialog", zh:"å¥½çš„ï¼Œè°¢è°¢ä½ ã€‚", py:"HÇo de, xiÃ¨xie nÇ.", ko:"ë„¤, ê°ì‚¬í•©ë‹ˆë‹¤.", tags:["ëŒ€í™”","ì†ë‹˜"] },
    { type:"dialog", zh:"è¿™æ˜¯ä½ çš„é’±ï¼Œè¯·ç‚¹ä¸€ä¸‹ã€‚", py:"ZhÃ¨ shÃ¬ nÇ de qiÃ¡n, qÇng diÇn yÃ­xiÃ .", ko:"ì—¬ê¸° ëˆì…ë‹ˆë‹¤. í•œë²ˆ ì„¸ì–´ë³´ì„¸ìš”.", tags:["ëŒ€í™”","ì§ì›"] },
    { type:"dialog", zh:"å¯¹çš„ï¼Œä¸€å…±äº”åƒå—ã€‚", py:"DuÃ¬ de, yÃ­gÃ²ng wÇ”qiÄn kuÃ i.", ko:"ë§ì•„ìš”, ì´ 5ì²œ ìœ„ì•ˆì´ì—ìš”.", tags:["ëŒ€í™”","í™•ì¸"] },

    { type:"narr", zh:"å°ä¸½æŠŠé’±æ”¾è¿›åŒ…é‡Œã€‚", py:"XiÇolÃ¬ bÇ qiÃ¡n fÃ ng jÃ¬n bÄo lÇ.", ko:"ìƒ¤ì˜¤ë¦¬ëŠ” ëˆì„ ê°€ë°©ì— ë„£ì—ˆë‹¤.", tags:["ë‚˜ë ˆì´ì…˜"] },

    { type:"dialog", zh:"è¿™æ˜¯ä½ çš„é“¶è¡Œå¡å’Œæ”¶æ®ã€‚", py:"ZhÃ¨ shÃ¬ nÇ de yÃ­nhÃ¡ngkÇ hÃ© shÅujÃ¹.", ko:"ì—¬ê¸° ì€í–‰ì¹´ë“œì™€ ì˜ìˆ˜ì¦ì…ë‹ˆë‹¤.", tags:["ëŒ€í™”","ì§ì›"] },
    { type:"dialog", zh:"å¥½çš„ï¼Œè°¢è°¢ã€‚", py:"HÇo de, xiÃ¨xie.", ko:"ë„¤, ê°ì‚¬í•©ë‹ˆë‹¤.", tags:["ëŒ€í™”","ì†ë‹˜"] },
    { type:"dialog", zh:"ä¸å®¢æ°”ã€‚", py:"BÃº kÃ¨qi.", ko:"ì²œë§Œì—ìš”.", tags:["ëŒ€í™”","ë§¤ë„ˆ"] },

    { type:"narr", zh:"å°ä¸½çªç„¶æƒ³åˆ°ä¸€ä»¶äº‹ï¼Œåˆé—®äº†å·¥ä½œäººå‘˜ã€‚", py:"XiÇolÃ¬ tÅ«rÃ¡n xiÇngdÃ o yÃ­ jiÃ n shÃ¬, yÃ²u wÃ¨n le gÅngzuÃ²rÃ©nyuÃ¡n.", ko:"ìƒ¤ì˜¤ë¦¬ëŠ” ê°‘ìê¸° í•œ ê°€ì§€ê°€ ë– ì˜¬ë¼ ë‹¤ì‹œ ì§ì›ì—ê²Œ ë¬¼ì—ˆë‹¤.", tags:["ë‚˜ë ˆì´ì…˜"] },

    { type:"dialog", zh:"ä¸å¥½æ„æ€ï¼Œæˆ‘å¯ä»¥é¡ºä¾¿é—®ä¸€ä¸‹å—ï¼Ÿ", py:"BÃ¹hÇoyÃ¬si, wÇ’ kÄ›yÇ shÃ¹nbiÃ n wÃ¨n yÃ­xiÃ  ma?", ko:"ì£„ì†¡í•œë°, ê²¸ì‚¬ê²¸ì‚¬ í•˜ë‚˜ ë¬¼ì–´ë´ë„ ë ê¹Œìš”?", tags:["ëŒ€í™”","ë§¤ë„ˆ"] },
    { type:"dialog", zh:"å¯ä»¥çš„ï¼Œè¯·è¯´ã€‚", py:"KÄ›yÇ de, qÇng shuÅ.", ko:"ë„¤, ë§ì”€í•˜ì„¸ìš”.", tags:["ëŒ€í™”","ì§ì›"] },
    { type:"dialog", zh:"å¦‚æœé“¶è¡Œå¡ä¸¢äº†ï¼Œæ€ä¹ˆåŠï¼Ÿ", py:"RÃºguÇ’ yÃ­nhÃ¡ngkÇ diÅ« le, zÄ›nme bÃ n?", ko:"ë§Œì•½ ì€í–‰ì¹´ë“œë¥¼ ìƒì–´ë²„ë¦¬ë©´ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?", tags:["ëŒ€í™”","ë¬¸ì œìƒí™©"] },
    { type:"dialog", zh:"å¯ä»¥å…ˆæŒ‚å¤±ï¼Œç„¶åå†è¡¥åŠä¸€å¼ æ–°å¡ã€‚", py:"KÄ›yÇ xiÄn guÃ shÄ«, rÃ¡nhÃ²u zÃ i bÇ”bÃ n yÃ¬ zhÄng xÄ«n kÇ.", ko:"ë¨¼ì € ë¶„ì‹¤ì‹ ê³ ë¥¼ í•˜ê³ , ê·¸ ë‹¤ìŒ ìƒˆ ì¹´ë“œë¥¼ ì¬ë°œê¸‰í•˜ë©´ ë©ë‹ˆë‹¤.", tags:["ëŒ€í™”","í•´ê²°"] },
    { type:"dialog", zh:"æ˜ç™½äº†ï¼Œè°¢è°¢ä½ ã€‚", py:"MÃ­ngbai le, xiÃ¨xie nÇ.", ko:"ì•Œê² ìŠµë‹ˆë‹¤, ê°ì‚¬í•©ë‹ˆë‹¤.", tags:["ëŒ€í™”","ì†ë‹˜"] },
    { type:"dialog", zh:"ä¸å®¢æ°”ã€‚", py:"BÃº kÃ¨qi.", ko:"ì²œë§Œì—ìš”.", tags:["ëŒ€í™”","ë§¤ë„ˆ"] },

    { type:"narr", zh:"å°ä¸½æ…¢æ…¢èµ°å‡ºé“¶è¡Œã€‚", py:"XiÇolÃ¬ mÃ nmÃ n zÇ’u chÅ« yÃ­nhÃ¡ng.", ko:"ìƒ¤ì˜¤ë¦¬ëŠ” ì²œì²œíˆ ì€í–‰ì„ ë‚˜ì™”ë‹¤.", tags:["ë‚˜ë ˆì´ì…˜"] },
    { type:"narr", zh:"ä»Šå¤©çš„äº‹æƒ…åŠå¾—å¾ˆé¡ºåˆ©ï¼Œå¥¹è§‰å¾—å¾ˆèˆ’å¿ƒã€‚", py:"JÄ«ntiÄn de shÃ¬qing bÃ n de hÄ›n shÃ¹nlÃ¬, tÄ juÃ©de hÄ›n shÅ«xÄ«n.", ko:"ì˜¤ëŠ˜ ì¼ì´ ì•„ì£¼ ìˆœì¡°ë¡­ê²Œ ì²˜ë¦¬ë˜ì–´ ë§ˆìŒì´ í¸ì•ˆí–ˆë‹¤.", tags:["ë‚˜ë ˆì´ì…˜","ë§ˆë¬´ë¦¬"] },
  ];

  const state = { deckMode:"all", deck:[], order:[], idx:0, flipped:false, unknownFirst:true, timer:null };

  const el = (id)=>document.getElementById(id);
  const cardEl = el("card");
  const frontZh = el("frontZh"), backZh = el("backZh"), backPy = el("backPy"), backKo = el("backKo");
  const posEl = el("pos"), totalEl = el("total"), barEl = el("bar");
  const frontChips = el("frontChips"), backChips = el("backChips");
  const frontTag = el("frontTag"), backTag = el("backTag");
  const toastEl = el("toast");

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"), 850);
  }

  function supportsTTS(){ return ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window); }
  function pickZhVoice(){
    const voices = window.speechSynthesis.getVoices() || [];
    return voices.find(v => (v.lang||"").toLowerCase().startsWith("zh-cn"))
        || voices.find(v => (v.lang||"").toLowerCase().startsWith("zh"))
        || voices.find(v => (v.name||"").toLowerCase().includes("chinese"))
        || null;
  }
  function speakZh(text){
    if(!supportsTTS()){ showToast("TTS ë¯¸ì§€ì›"); return; }
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    const v = pickZhVoice();
    if(v) u.voice = v;
    u.lang = (v && v.lang) ? v.lang : "zh-CN";
    u.rate = 0.95; u.pitch = 1.0;
    u.onstart = ()=> showToast("ì½ëŠ” ì¤‘â€¦");
    u.onend = ()=> showToast("ì™„ë£Œ");
    u.onerror = ()=> showToast("TTS ì˜¤ë¥˜");
    window.speechSynthesis.speak(u);
  }
  function stopSpeak(){ if(supportsTTS()) window.speechSynthesis.cancel(); showToast("ì¤‘ì§€"); }

  function buildDeck(mode){
    const base = mode==="dialog" ? CARDS_ALL.filter(c=>c.type==="dialog")
               : mode==="narr" ? CARDS_ALL.filter(c=>c.type==="narr")
               : CARDS_ALL.slice();
    state.deck = base.map((c,i)=>({ ...c, id:i, weight:1, seen:0, known:0, unknown:0 }));
    buildOrder();
    state.idx = 0;
  }

  function buildOrder(){
    const pool = [];
    for(const c of state.deck){
      let w = Math.max(1, Math.round(c.weight));
      if(state.unknownFirst) w += Math.min(6, c.unknown);
      for(let k=0;k<w;k++) pool.push(c.id);
    }
    const order = [];
    const N = 200;
    for(let i=0;i<N;i++) order.push(pool[Math.floor(Math.random()*pool.length)]);
    state.order = order;
  }

  function currentCard(){ return state.deck[state.order[state.idx]]; }

  function render(){
    const c = currentCard();
    frontZh.textContent = c.zh;
    backZh.textContent  = c.zh;
    backPy.textContent  = c.py;
    backKo.textContent  = c.ko;

    const typeLabel = c.type==="dialog" ? "ëŒ€í™”" : "ë‚˜ë ˆì´ì…˜";
    frontTag.textContent = `ì•ë©´ Â· ì¤‘êµ­ì–´ Â· ${typeLabel}`;
    backTag.textContent  = `ë’·ë©´ Â· ë³‘ìŒ/ëœ» Â· ${typeLabel}`;

    const chips = (arr)=> (arr||[]).map(t=>`<span class="chip">${t}</span>`).join("");
    frontChips.innerHTML = chips(c.tags||[]);
    backChips.innerHTML  = chips([`ë³¸ ${c.seen}`, `ì• ${c.known}`, `ëª¨ë¦„ ${c.unknown}`]);

    totalEl.textContent = state.order.length;
    posEl.textContent = (state.idx + 1);
    barEl.style.width = `${((state.idx+1)/state.order.length)*100}%`;

    state.flipped = false;
    cardEl.classList.remove("flipped");
  }

  function flip(){ state.flipped = !state.flipped; cardEl.classList.toggle("flipped", state.flipped); }
  function next(){ state.idx = (state.idx + 1) % state.order.length; render(); }
  function markAgain(){
    const c = currentCard();
    c.seen++; c.unknown++; c.weight = Math.min(12, c.weight + 2);
    showToast("ëª¨ë¦„(ë°˜ë³µâ†‘)"); next();
  }
  function markGood(){
    const c = currentCard();
    c.seen++; c.known++; c.weight = Math.max(1, c.weight - 1);
    showToast("ì•(ë°˜ë³µâ†“)"); next();
  }
  function shuffle(){ buildOrder(); state.idx = 0; render(); showToast("ì…”í”Œ"); }

  function setDeckMode(mode){
    state.deckMode = mode;
    el("deckAll").classList.toggle("active", mode==="all");
    el("deckDialog").classList.toggle("active", mode==="dialog");
    el("deckNarr").classList.toggle("active", mode==="narr");
    buildDeck(mode);
    render();
    showToast(mode==="all" ? "ì „ì²´" : mode==="dialog" ? "ëŒ€í™”ë§Œ" : "ë‚˜ë ˆì´ì…˜ë§Œ");
  }

  function setAutoplay(on){
    if(state.timer) clearInterval(state.timer);
    state.timer = null;
    if(on){
      state.timer = setInterval(()=>{ if(!state.flipped) flip(); else next(); }, 3000);
    }
  }

  // ë²„íŠ¼
  el("deckAll").addEventListener("click", ()=> setDeckMode("all"));
  el("deckDialog").addEventListener("click", ()=> setDeckMode("dialog"));
  el("deckNarr").addEventListener("click", ()=> setDeckMode("narr"));
  el("shuffleBtn").addEventListener("click", shuffle);

  el("flipBtn").addEventListener("click", flip);
  el("nextBtn").addEventListener("click", next);
  el("againBtn").addEventListener("click", markAgain);
  el("goodBtn").addEventListener("click", markGood);

  cardEl.addEventListener("click", flip);

  el("ttsZhBtn").addEventListener("click", ()=> speakZh(currentCard().zh));
  el("ttsStopBtn").addEventListener("click", stopSpeak);

  el("autoPlay").addEventListener("change", (e)=> setAutoplay(e.target.checked));
  el("unknownFirst").addEventListener("change", (e)=> { state.unknownFirst = e.target.checked; shuffle(); });

  // ìŠ¤ì™€ì´í”„: ì™¼ìª½=ë‹¤ìŒ / ì˜¤ë¥¸ìª½=ì´ì „
  let sx=null, sy=null, moved=false;
  cardEl.addEventListener("touchstart", (e)=>{
    const t=e.touches[0]; sx=t.clientX; sy=t.clientY; moved=false;
  }, {passive:true});
  cardEl.addEventListener("touchmove", (e)=>{
    if(sx==null) return;
    const t=e.touches[0];
    const dx=t.clientX-sx, dy=t.clientY-sy;
    if(Math.abs(dx)>18 && Math.abs(dx)>Math.abs(dy)) moved=true;
  }, {passive:true});
  cardEl.addEventListener("touchend", (e)=>{
    if(sx==null) return;
    const t=e.changedTouches[0]; const dx=t.clientX-sx;
    sx=null; sy=null;
    if(!moved){ flip(); return; }
    if(dx < -40) next();
    else if(dx > 40){
      // ì´ì „ ê¸°ëŠ¥ì€ order ë‚´ì—ì„œ idx-1ë¡œ êµ¬í˜„(ëª¨ë°”ì¼ì—ì„œë„ í•„ìš”í•˜ë©´ ì¶”ê°€ ê°€ëŠ¥)
      state.idx = (state.idx - 1 + state.order.length) % state.order.length;
      render();
    }
  });

  // ì´ˆê¸°
  setDeckMode("all");
  if(!supportsTTS()) showToast("TTS ë¯¸ì§€ì› ë¸Œë¼ìš°ì €");
</script>
</body>
</html>
