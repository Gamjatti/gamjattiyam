<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¤‘êµ­ì–´ ë‹¨ì–´ í•™ìŠµ</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:linear-gradient(135deg,#e0f2e9 0%,#d4e7f7 100%);
      min-height:100vh;
      padding:20px;
    }
    .container{ width:100%; max-width:1000px; margin:0 auto; }
    
    /* ì¹´í…Œê³ ë¦¬ ì„ íƒ í™”ë©´ */
    .category-screen{
      background:white; border-radius:20px;
      box-shadow:0 10px 40px rgba(0,0,0,0.1);
      padding:40px;
    }
    .app-title{
      text-align:center; font-size:36px; font-weight:900;
      color:#333; margin-bottom:15px;
    }
    .app-subtitle{
      text-align:center; color:#888; margin-bottom:40px; font-size:16px;
    }
    .category-grid{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap:20px; margin-bottom:30px;
    }
    .category-card{
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius:16px; padding:30px; cursor:pointer;
      transition:all .3s; border:none; color:white;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    .category-card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 20px rgba(0,0,0,0.15);
    }
    .category-card.cat-1{ background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .category-card.cat-2{ background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    
    .category-name{
      font-size:28px; font-weight:900; margin-bottom:10px;
    }
    .category-desc{
      font-size:14px; opacity:0.9; margin-bottom:15px;
    }
    .category-count{
      font-size:13px; opacity:0.8;
    }
    .all-study-btn{
      background:linear-gradient(90deg,#22c55e 0%,#3b82f6 100%);
      color:white; border:none;
      padding:18px 30px; border-radius:12px;
      font-size:18px; font-weight:800; cursor:pointer;
      width:100%;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      transition:all .3s;
    }
    .all-study-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(0,0,0,0.15);
    }

    /* í•™ìŠµ í™”ë©´ */
    .study-screen{ display:none; }
    .study-screen.active{ display:block; }
    
    .back-header{
      display:flex; align-items:center; gap:15px; margin-bottom:25px;
      flex-wrap:wrap;
    }
    .back-btn{
      background:white; border:none; border-radius:12px;
      padding:12px 20px; font-size:16px; font-weight:700;
      cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.1);
      transition:all .3s; color:#555;
    }
    .back-btn:hover{
      background:#f5f5f5; transform:translateY(-2px);
    }
    .current-lesson{
      font-size:20px; font-weight:900; color:#333;
      background:white; padding:12px 24px; border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }

    .progress-section{ margin-bottom:20px; background:white; 
      border-radius:16px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .progress-header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:10px; gap:12px; flex-wrap:wrap;
    }
    .progress-text{ font-size:14px; font-weight:600; color:#555; }
    .stats{ display:flex; gap:15px; align-items:center; flex-wrap:wrap; }
    .stat-correct{ color:#22c55e; font-size:14px; font-weight:700; }
    .stat-incorrect{ color:#ef4444; font-size:14px; font-weight:700; }
    .reset-btn{
      background:none; border:none; color:#888; cursor:pointer;
      font-size:18px; padding:5px; transition:color .3s;
    }
    .reset-btn:hover{ color:#555; }
    .progress-bar{
      width:100%; height:8px; background:#ddd; border-radius:10px; overflow:hidden;
    }
    .progress-fill{
      height:100%;
      background:linear-gradient(90deg,#22c55e 0%,#3b82f6 100%);
      transition:width .5s ease;
    }
    .review-notice{ margin-top:8px; font-size:13px; color:#f97316; font-weight:600; }
    
    .card-container{
      background:white; border-radius:20px;
      box-shadow:0 10px 40px rgba(0,0,0,0.1);
      padding:40px;
    }
    .question-section{
      text-align:center; margin-bottom:40px; padding-bottom:30px;
      border-bottom:2px solid #f0f0f0;
    }
    .chinese-word{ font-size:72px; font-weight:bold; color:#333; margin-bottom:15px; }
    .pinyin{ font-size:28px; color:#888; margin-bottom:25px; }

    .pronunciation-btn{
      background:#3b82f6; color:white; border:none;
      padding:12px 24px; border-radius:50px;
      font-size:16px; font-weight:700; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow:0 4px 12px rgba(59,130,246,0.3);
      transition:all .3s;
    }
    .pronunciation-btn:hover{
      background:#2563eb;
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(59,130,246,0.4);
    }
    .pronunciation-btn:disabled{
      opacity:.65;
      cursor:not-allowed;
      transform:none;
    }
    .pronunciation-btn.playing{ animation:pulse 1s infinite; }
    @keyframes pulse{ 0%,100%{opacity:1} 50%{opacity:.7} }

    .answer-section{ margin-top:30px; }
    .question-prompt{
      text-align:center; color:#666; font-weight:700;
      margin-bottom:20px; font-size:16px;
    }
    .options{ display:grid; gap:12px; }
    .option-btn{
      padding:20px; border-radius:12px; font-size:18px; font-weight:700;
      cursor:pointer; transition:all .3s;
      text-align:left; border:2px solid #ddd; background:white;
      display:flex; justify-content:space-between; align-items:center;
    }
    .option-btn:hover:not(:disabled){
      background:#eff6ff;
      border-color:#3b82f6;
    }
    .option-btn.correct{ background:#22c55e; color:white; border-color:#16a34a; }
    .option-btn.incorrect{ background:#ef4444; color:white; border-color:#dc2626; }
    .option-btn.disabled{ background:#f5f5f5; opacity:.5; cursor:not-allowed; }
    .option-text{ white-space:pre-line; }
    .icon{ font-size:24px; }

    .result-message{
      margin-top:25px; padding:16px; border-radius:12px;
      text-align:center; font-weight:800; font-size:16px;
    }
    .result-message.correct{ background:#dcfce7; color:#166534; }
    .result-message.incorrect{ background:#fee2e2; color:#991b1b; }

    .hint{ text-align:center; color:#888; font-size:14px; margin-top:30px; }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.75);
      color:white;
      padding:10px 14px;
      border-radius:12px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
      max-width:min(720px, calc(100% - 24px));
      text-align:center;
      line-height:1.35;
    }
    .toast.show{ opacity:1; }

    .completion-screen{
      background:white; border-radius:20px;
      box-shadow:0 10px 40px rgba(0,0,0,0.1);
      padding:50px; text-align:center;
      max-width:500px; margin:0 auto;
    }
    .completion-emoji{ font-size:80px; margin-bottom:20px; }
    .completion-title{ font-size:32px; font-weight:900; color:#333; margin-bottom:30px; }
    .completion-stats{ background:#f9fafb; border-radius:12px; padding:25px; margin-bottom:30px; }
    .completion-stat{ color:#666; margin-bottom:10px; font-size:16px; }
    .completion-stat:last-child{ margin-bottom:0; }
    .stat-value{ font-weight:900; font-size:20px; }
    .stat-value.correct{ color:#22c55e; }
    .stat-value.incorrect{ color:#ef4444; }
    .stat-value.rate{ color:#3b82f6; }
    .restart-btn{
      background:linear-gradient(90deg,#22c55e 0%,#3b82f6 100%);
      color:white; border:none;
      padding:15px 30px; border-radius:12px;
      font-size:16px; font-weight:800; cursor:pointer;
      width:100%;
      display:flex; align-items:center; justify-content:center; gap:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      transition:all .3s; margin-bottom:12px;
    }
    .restart-btn:hover{ transform:translateY(-2px); box-shadow:0 6px 16px rgba(0,0,0,0.15); }

    @media (max-width:640px){
      .chinese-word{ font-size:56px; }
      .pinyin{ font-size:22px; }
      .card-container{ padding:25px; }
      .option-btn{ font-size:16px; padding:16px; }
      .category-screen{ padding:25px; }
      .app-title{ font-size:28px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ í™”ë©´ -->
    <div class="category-screen" id="categoryScreen">
      <h1 class="app-title">ğŸ‡¨ğŸ‡³ ì¤‘êµ­ì–´ ë‹¨ì–´ í•™ìŠµ</h1>
      <p class="app-subtitle">ê³¼ë³„ë¡œ í•™ìŠµí•˜ê±°ë‚˜ ì „ì²´ ë‹¨ì–´ë¥¼ í•œë²ˆì— ê³µë¶€í•˜ì„¸ìš”</p>
      
      <div class="category-grid" id="categoryGrid"></div>
      
      <button class="all-study-btn" id="allStudyBtn">
        ğŸ“š ì „ì²´ ë‹¨ì–´ í•™ìŠµí•˜ê¸° (ì´ 32ê°œ)
      </button>
    </div>

    <!-- í•™ìŠµ í™”ë©´ -->
    <div class="study-screen" id="studyScreen">
      <div class="back-header">
        <button class="back-btn" id="backBtn">â† ê³¼ ì„ íƒ</button>
        <div class="current-lesson" id="currentLesson"></div>
      </div>

      <div id="studyContent"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ë‹¨ì–´ ë°ì´í„°
    const categories = [
      {
        id: 1,
        name: '1ê³¼',
        desc: '16ê°œ ë‹¨ì–´',
        words: [
          { id:'anquan',  chinese:'å®‰å…¨', pinyin:'ÄnquÃ¡n',  korean:'ì•ˆì „í•˜ë‹¤' },
          { id:'kunnan',  chinese:'å›°éš¾', pinyin:'kÃ¹nnan',  korean:'ì–´ë ¤ì›€, ê³¤ë€\nê³¤ë€í•˜ë‹¤, ì–´ë µë‹¤' },
          { id:'biaoshi', chinese:'è¡¨ç¤º', pinyin:'biÇoshÃ¬', korean:'â‘  í‘œëª…í•˜ë‹¤, ë‚˜íƒ€ë‚´ë‹¤\nâ‘¡ ì˜ë¯¸í•˜ë‹¤, ê°€ë¦¬í‚¤ë‹¤' },
          { id:'cuowu',   chinese:'é”™è¯¯', pinyin:'cuÃ²wÃ¹',   korean:'ì˜ëª», ì°©ì˜¤\nì˜ëª»ë˜ë‹¤, ë¶€ì •í™•í•˜ë‹¤' },
          { id:'jiaoyu',  chinese:'æ•™è‚²', pinyin:'jiÃ oyÃ¹',  korean:'êµìœ¡í•˜ë‹¤\nêµìœ¡' },
          { id:'biru',    chinese:'æ¯”å¦‚', pinyin:'bÇrÃº',    korean:'ì˜ˆë¥¼ ë“¤ë‹¤' },
          { id:'anshi',   chinese:'æŒ‰æ—¶', pinyin:'Ã nshÃ­',   korean:'ì œì‹œê°„ì—, ì‹œê°„ì— ë§ì¶”ì–´' },
          { id:'tongguo', chinese:'é€šè¿‡', pinyin:'tÅngguÃ²', korean:'í†µê³¼í•˜ë‹¤\n~ì„ í†µí•´' },
          { id:'yinqi',   chinese:'å¼•èµ·', pinyin:'yÇnqÇ',   korean:'ë¶ˆëŸ¬ì¼ìœ¼í‚¤ë‹¤, (ì£¼ì˜ë¥¼) ëŒë‹¤, ì•¼ê¸°í•˜ë‹¤' },
          { id:'yan',     chinese:'ç›',   pinyin:'yÃ¡n',     korean:'ì†Œê¸ˆ' },
          { id:'senlin',  chinese:'æ£®æ—', pinyin:'sÄ“nlÃ­n',  korean:'ì‚¼ë¦¼, ìˆ²' },
          { id:'yuedu',   chinese:'é˜…è¯»', pinyin:'yuÃ¨dÃº',   korean:'ì½ê³  ì´í•´í•˜ë‹¤' },
          { id:'shou',    chinese:'æ”¶',   pinyin:'shÅu',    korean:'ë°›ë‹¤' },
          { id:'yonggan', chinese:'å‹‡æ•¢', pinyin:'yÇ’nggÇn', korean:'ìš©ê°í•˜ë‹¤' },
          { id:'xianjin', chinese:'ç°é‡‘', pinyin:'xiÃ njÄ«n', korean:'í˜„ê¸ˆ' },
          { id:'youqi',   chinese:'å°¤å…¶', pinyin:'yÃ³uqÃ­',   korean:'ë”ìš±ì´, íŠ¹íˆ' }
        ]
      },
      {
        id: 2,
        name: '2ê³¼',
        desc: '16ê°œ ë‹¨ì–´',
        words: [
          { id:'diu',       chinese:'ä¸¢',     pinyin:'diÅ«',       korean:'ìƒì–´ë²„ë¦¬ë‹¤' },
          { id:'diao',      chinese:'æ‰',     pinyin:'diÃ o',      korean:'ë–¨ì–´ì§€ë‹¤, ë–¨ì–´ëœ¨ë¦¬ë‹¤, ë¹ ëœ¨ë¦¬ë‹¤' },
          { id:'xiangpi',   chinese:'æ©¡çš®',   pinyin:'xiÃ ngpÃ­',   korean:'ì§€ìš°ê°œ' },
          { id:'yuanlai',   chinese:'åŸæ¥',   pinyin:'yuÃ¡nlÃ¡i',   korean:'ì›ë˜, ë³¸ë˜\nì›ë˜ì˜\nì•Œê³  ë³´ë‹ˆ' },
          { id:'zhiwu',     chinese:'æ¤ç‰©',   pinyin:'zhÃ­wÃ¹',     korean:'ì‹ë¬¼' },
          { id:'xiaohuozi', chinese:'å°ä¼™å­', pinyin:'xiÇohuÇ’zi', korean:'ì Šì€ì´, ì²­ë…„, ì´ê°' },
          { id:'yagao',     chinese:'ç‰™è†',   pinyin:'yÃ¡gÄo',     korean:'ì¹˜ì•½' },
          { id:'yezi',      chinese:'å¶å­',   pinyin:'yÃ¨zi',      korean:'ì, ìì‚¬ê·€' },
          { id:'suoyou',    chinese:'æ‰€æœ‰',   pinyin:'suÇ’yÇ’u',    korean:'ëª¨ë“ , ì „ë¶€ì˜' },
          { id:'langman',   chinese:'æµªæ¼«',   pinyin:'lÃ ngmÃ n',   korean:'ë‚­ë§Œì ì´ë‹¤' },
          { id:'xiyin',     chinese:'å¸å¼•',   pinyin:'xÄ«yÇn',     korean:'ë§¤ë£Œì‹œí‚¤ë‹¤, ëŒì–´ë‹¹ê¸°ë‹¤' },
          { id:'haiyang',   chinese:'æµ·æ´‹',   pinyin:'hÇiyÃ¡ng',   korean:'í•´ì–‘, ë°”ë‹¤' },
          { id:'zhongshi', chinese:'é‡è§†',   pinyin:'zhÃ²ngshÃ¬', korean:'ì¤‘ì‹œí•˜ë‹¤, ì¤‘ìš”ì‹œí•˜ë‹¤' },
          { id:'jiangjin', chinese:'å¥–é‡‘',   pinyin:'jiÇngjÄ«n', korean:'ìƒì—¬ê¸ˆ, ë³´ë„ˆìŠ¤' },
          { id:'di',        chinese:'åº•',     pinyin:'dÇ',        korean:'â‘  (í•œ í•´ì˜ í•œ ë‹¬ì˜) ë\nâ‘¡ ë°‘, ë°”ë‹¥' },
          { id:'lia',       chinese:'ä¿©',     pinyin:'liÇ',       korean:'ë‘ ì‚¬ëŒ, ë‘ ê°œ' }
        ]
      }
    ];

    let currentCategory = null;
    let cards = [];
    let currentIndex = 0;
    let options = [];
    let selectedAnswer = null;
    let showResult = false;
    let stats = { correct: 0, incorrect: 0 };
    let isPlaying = false;
    const mastered = new Set();

    const toastEl = document.getElementById("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 1600);
    }

    function pickChineseVoice(voices){
      if(!voices || voices.length === 0) return null;
      const byLangExact = (lang) => voices.find(v => (v.lang || "").toLowerCase() === lang);
      const byLangStart = (prefix) => voices.find(v => (v.lang || "").toLowerCase().startsWith(prefix));
      return (
        byLangExact("zh-cn") ||
        byLangExact("zh-hans-cn") ||
        byLangStart("zh-cn") ||
        byLangStart("zh-hans") ||
        byLangExact("zh-tw") ||
        byLangExact("zh-hk") ||
        byLangStart("zh") ||
        voices.find(v => /mandarin|chinese|zh/i.test(v.name || "")) ||
        null
      );
    }

    function getVoicesReady(){
      return new Promise((resolve) => {
        const synth = window.speechSynthesis;
        if(!synth) return resolve([]);
        let voices = synth.getVoices();
        if(voices && voices.length) return resolve(voices);
        const timer = setTimeout(() => {
          resolve(synth.getVoices() || []);
        }, 1200);
        synth.onvoiceschanged = () => {
          clearTimeout(timer);
          synth.onvoiceschanged = null;
          resolve(synth.getVoices() || []);
        };
      });
    }

    async function playPronunciation(text) {
      if (!("speechSynthesis" in window)) {
        toast("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ê¸°ëŠ¥ì´ ì§€ì›ë˜ì§€ ì•Šì•„ìš” ğŸ˜­");
        return;
      }
      const synth = window.speechSynthesis;
      synth.cancel();
      const voices = await getVoicesReady();
      const voice = pickChineseVoice(voices);
      if(!voice){
        toast("âš ï¸ ì´ ê¸°ê¸°/ë¸Œë¼ìš°ì €ì— ì¤‘êµ­ì–´ ìŒì„±ì´ ì—†ì–´ìš”. (ì¤‘êµ­ì–´ TTS ì„¤ì¹˜ í•„ìš”)");
        return;
      }
      isPlaying = true;
      renderStudy();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.voice = voice;
      utterance.lang = voice.lang || "zh-CN";
      utterance.rate = 0.78;
      utterance.pitch = 1.0;
      utterance.volume = 1.0;
      utterance.onend = () => { isPlaying = false; renderStudy(); };
      utterance.onerror = () => { isPlaying = false; renderStudy(); };
      synth.speak(utterance);
    }

    function showCategoryScreen() {
      document.getElementById('categoryScreen').style.display = 'block';
      document.getElementById('studyScreen').classList.remove('active');
      window.speechSynthesis?.cancel?.();
      renderCategories();
    }

    function renderCategories() {
      const grid = document.getElementById('categoryGrid');
      grid.innerHTML = categories.map((cat, idx) => `
        <button class="category-card cat-${cat.id}" data-cat="${cat.id}">
          <div class="category-name">${cat.name}</div>
          <div class="category-desc">${cat.desc}</div>
          <div class="category-count">ğŸ“ ${cat.words.length}ê°œ ë‹¨ì–´</div>
        </button>
      `).join('');

      document.querySelectorAll('.category-card').forEach(btn => {
        btn.addEventListener('click', () => {
          const catId = Number(btn.getAttribute('data-cat'));
          startStudy(catId);
        });
      });

      document.getElementById('allStudyBtn').onclick = () => startStudy('all');
    }

    function startStudy(categoryId) {
      currentCategory = categoryId;
      
      if (categoryId === 'all') {
        const allWords = categories.flatMap(c => c.words);
        cards = allWords.map(v => ({
          ...v,
          reviewed: false,
          understood: null,
          isReview: false
        }));
      } else {
        const category = categories.find(c => c.id === categoryId);
        cards = category.words.map(v => ({
          ...v,
          reviewed: false,
          understood: null,
          isReview: false
        }));
      }

      currentIndex = 0;
      selectedAnswer = null;
      showResult = false;
      stats = { correct: 0, incorrect: 0 };
      mastered.clear();
      
      generateOptions();
      
      document.getElementById('categoryScreen').style.display = 'none';
      document.getElementById('studyScreen').classList.add('active');
      
      updateLessonHeader();
      renderStudy();
    }

    function updateLessonHeader() {
      const lessonEl = document.getElementById('currentLesson');
      if (currentCategory === 'all') {
        lessonEl.textContent = 'ğŸ“š ì „ì²´ ë‹¨ì–´ í•™ìŠµ';
      } else {
        const cat = categories.find(c => c.id === currentCategory);
        lessonEl.textContent = `${cat.name} - ${cat.desc}`;
      }
    }

    function generateOptions() {
      const currentCard = cards[currentIndex];
      if (!currentCard) return;

      const correctAnswer = currentCard.korean;
      
      let allWords;
      if (currentCategory === 'all') {
        allWords = categories.flatMap(c => c.words);
      } else {
        const category = categories.find(c => c.id === currentCategory);
        allWords = category.words;
      }

      const wrongAnswers = allWords
        .filter(v => v.korean !== correctAnswer)
        .sort(() => Math.random() - 0.5)
        .slice(0, 3)
        .map(v => v.korean);

      options = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5);
    }

    function handleAnswer(optionIndex) {
      if (showResult) return;

      const currentCard = cards[currentIndex];
      if (!currentCard) return;

      const answer = options[optionIndex];
      selectedAnswer = answer;
      showResult = true;

      const isCorrect = answer === currentCard.korean;

      cards[currentIndex] = {
        ...currentCard,
        reviewed: true,
        understood: isCorrect
      };

      if (isCorrect) {
        stats.correct += 1;
        mastered.add(currentCard.id);
      } else {
        stats.incorrect += 1;
        cards.push({
          ...currentCard,
          reviewed: false,
          understood: null,
          isReview: true
        });
      }

      renderStudy();

      setTimeout(() => {
        if (currentIndex < cards.length - 1) {
          currentIndex++;
          selectedAnswer = null;
          showResult = false;
          generateOptions();
          renderStudy();
        } else {
          renderStudy();
        }
      }, 1100);
    }

    function resetStudy() {
      window.speechSynthesis?.cancel?.();
      startStudy(currentCategory);
    }

    function getButtonClass(option) {
      if (!showResult) return 'option-btn';
      const currentCard = cards[currentIndex];
      if (!currentCard) return 'option-btn';
      if (option === currentCard.korean) return 'option-btn correct';
      if (option === selectedAnswer && option !== currentCard.korean) return 'option-btn incorrect';
      return 'option-btn disabled';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderStudy() {
      const contentEl = document.getElementById('studyContent');
      const currentCard = cards[currentIndex];

      let allWordsCount;
      if (currentCategory === 'all') {
        allWordsCount = categories.flatMap(c => c.words).length;
      } else {
        const category = categories.find(c => c.id === currentCategory);
        allWordsCount = category.words.length;
      }

      const masteredCount = mastered.size;
      const notUnderstoodCount = cards.filter(c => c.reviewed && c.understood === false).length;

      if (!currentCard) {
        const total = stats.correct + stats.incorrect;
        const accuracy = total === 0 ? 0 : Math.round((stats.correct / total) * 100);

        contentEl.innerHTML =
          '<div class="completion-screen">' +
            '<div class="completion-emoji">ğŸ‰</div>' +
            '<h2 class="completion-title">í•™ìŠµ ì™„ë£Œ!</h2>' +
            '<div class="completion-stats">' +
              '<p class="completion-stat">ì •ë‹µ: <span class="stat-value correct">' + stats.correct + '</span></p>' +
              '<p class="completion-stat">ì˜¤ë‹µ: <span class="stat-value incorrect">' + stats.incorrect + '</span></p>' +
              '<p class="completion-stat">ì •ë‹µë¥ : <span class="stat-value rate">' + accuracy + '%</span></p>' +
            '</div>' +
            '<button class="restart-btn" id="restartBtn"><span>ğŸ”„</span> ë‹¤ì‹œ í•™ìŠµí•˜ê¸°</button>' +
            '<button class="restart-btn" id="backToMenuBtn" style="background:#6b7280;"><span>ğŸ“š</span> ê³¼ ì„ íƒìœ¼ë¡œ</button>' +
          '</div>';

        document.getElementById('restartBtn').addEventListener('click', resetStudy);
        document.getElementById('backToMenuBtn').addEventListener('click', showCategoryScreen);
        return;
      }

      const progressPercent = (masteredCount / allWordsCount) * 100;

      let html =
        '<div class="progress-section">' +
          '<div class="progress-header">' +
            '<span class="progress-text">ë§ˆìŠ¤í„°: ' + masteredCount + '/' + allWordsCount + '</span>' +
            '<div class="stats">' +
              '<span class="stat-correct">âœ“ ' + stats.correct + '</span>' +
              '<span class="stat-incorrect">âœ— ' + stats.incorrect + '</span>' +
              '<button class="reset-btn" id="resetBtn" title="ë¦¬ì…‹">ğŸ”„</button>' +
            '</div>' +
          '</div>' +
          '<div class="progress-bar">' +
            '<div class="progress-fill" style="width:' + progressPercent + '%"></div>' +
          '</div>';

      if (notUnderstoodCount > 0) {
        html += '<p class="review-notice">ğŸ’ª ë³µìŠµ ëŒ€ê¸°: ' + notUnderstoodCount + 'ê°œ</p>';
      }

      html +=
        '</div>' +
        '<div class="card-container">' +
          '<div class="question-section">' +
            '<div class="chinese-word">' + currentCard.chinese + '</div>' +
            '<div class="pinyin">' + currentCard.pinyin + '</div>' +
            '<button class="pronunciation-btn' + (isPlaying ? ' playing' : '') + '" id="speakBtn"' + (isPlaying ? ' disabled' : '') + '>' +
              'ğŸ”Š ë°œìŒ ë“£ê¸°' +
            '</button>' +
          '</div>' +
          '<div class="answer-section">' +
            '<p class="question-prompt">ì´ ë‹¨ì–´ì˜ ëœ»ì€?</p>' +
            '<div class="options">';

      for (let i = 0; i < options.length; i++) {
        const option = options[i];
        html +=
          '<button class="' + getButtonClass(option) + '" data-idx="' + i + '"' + (showResult ? ' disabled' : '') + '>' +
            '<span class="option-text">' + escapeHtml(option) + '</span>';

        if (showResult && option === currentCard.korean) html += '<span class="icon">âœ“</span>';
        if (showResult && option === selectedAnswer && option !== currentCard.korean) html += '<span class="icon">âœ—</span>';

        html += '</button>';
      }

      html +=
            '</div>' +
          '</div>';

      if (showResult) {
        const ok = selectedAnswer === currentCard.korean;
        html +=
          '<div class="result-message ' + (ok ? 'correct' : 'incorrect') + '">' +
            (ok ? 'âœ¨ ì •ë‹µì…ë‹ˆë‹¤!' : 'ğŸ’ª í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë‚˜ì˜¬ ê±°ì˜ˆìš”!') +
          '</div>';
      }

      html +=
        '</div>' +
        '<div class="hint">ğŸ’¡ ì •ë‹µì„ ì„ íƒí•˜ì„¸ìš”. í‹€ë¦° ë¬¸ì œëŠ” ìë™ìœ¼ë¡œ ë‹¤ì‹œ ë‚˜ì˜µë‹ˆë‹¤</div>';

      contentEl.innerHTML = html;

      document.getElementById('resetBtn').addEventListener('click', resetStudy);
      document.getElementById('speakBtn').addEventListener('click', () => playPronunciation(currentCard.chinese));

      document.querySelectorAll('.option-btn[data-idx]').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.getAttribute('data-idx'));
          handleAnswer(idx);
        });
      });
    }

    // ì´ˆê¸°í™”
    document.getElementById('backBtn').addEventListener('click', showCategoryScreen);
    showCategoryScreen();
  </script>
</body>
</html>
